<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Quest 3 Passthrough Galaxies</title>
<style>
  body { margin: 0; overflow: hidden; }
</style>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer;

init();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'], optionalFeatures: ['dom-overlay'], domOverlay: { root: document.body } }));

  createGalaxies(100);

  renderer.setAnimationLoop(() => {
    scene.traverse(obj => {
      if (obj.userData.isGalaxy) {
        obj.rotation.y += 0.0005;
        obj.rotation.x += 0.0002;
      }
    });
    renderer.render(scene, camera);
  });
}

function createGalaxies(count) {
  const galaxyTypes = ['spiral', 'elliptical', 'irregular'];

  for (let i = 0; i < count; i++) {
    const type = galaxyTypes[Math.floor(Math.random() * galaxyTypes.length)];
    const color = new THREE.Color().setHSL(Math.random(), 0.7, 0.6);
    const galaxyMaterial = new THREE.PointsMaterial({ size: 0.05, transparent: true, opacity: 0.8, depthWrite: false, blending: THREE.AdditiveBlending, color });

    const galaxy = new THREE.Points(generateGalaxyGeometry(type), galaxyMaterial);
    galaxy.userData.isGalaxy = true;

    const distance = THREE.MathUtils.randFloat(25, 120);
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos((Math.random() * 2) - 1);
    galaxy.position.set(
      distance * Math.sin(phi) * Math.cos(theta),
      distance * Math.sin(phi) * Math.sin(theta),
      distance * Math.cos(phi)
    );

    galaxy.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);

    scene.add(galaxy);
  }
}

function generateGalaxyGeometry(type) {
  const geometry = new THREE.BufferGeometry();
  const particles = 3000 + Math.floor(Math.random() * 2000);
  const positions = new Float32Array(particles * 3);

  for (let i = 0; i < particles; i++) {
    let x, y, z;
    if (type === 'spiral') {
      const arms = 5;
      const arm = i % arms;
      const angle = (i / particles) * Math.PI * 10 + (arm * (2 * Math.PI / arms));
      const radius = Math.sqrt(i / particles) * (4 + Math.random() * 6);
      x = radius * Math.cos(angle) + (Math.random() - 0.5) * 0.5;
      y = (Math.random() - 0.5) * 0.5;
      z = radius * Math.sin(angle) + (Math.random() - 0.5) * 0.5;
    } else if (type === 'elliptical') {
      x = (Math.random() - 0.5) * 8;
      y = (Math.random() - 0.5) * 4;
      z = (Math.random() - 0.5) * 8;
    } else {
      x = (Math.random() - 0.5) * 10;
      y = (Math.random() - 0.5) * 10;
      z = (Math.random() - 0.5) * 10;
    }
    positions.set([x, y, z], i * 3);
  }

  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  return geometry;
}
</script>
</head>
<body>
</body>
</html>
